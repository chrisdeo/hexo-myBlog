---
title: 如何处理大量DIV插入问题
date: 2019-07-22 16:43:46
tags:
  - HTML
  - DOM
  - Javascript
  - Event Loop
---

> &emsp;&emsp;这篇文章真是有一种文艺复兴的感觉；不过从解决问题的角度上看，一些处理问题的方案还是能综合应用到不同的实际场景中的。

<escape><!-- more --></escape>

## 背景

&emsp;&emsp;最早其实是在一次分享会上听到了相关问题的讲解，近期又在一次面试中和面试官讨论了这个问题：**如何处理大量DIV插入问题？**。

&emsp;&emsp;那么本文就以这样一个DEMO来进行讨论：**如何优化点击一个button往`container`容器中插入2W个`div`的场景**。

#### 方案一：笨比插入

&emsp;&emsp;什么是憨憨插入呢？就是你直接操作DOM树，通过找到父亲节点然后根据要插入的DIV数量循环调用`appendChild`插入；这大概是刚接触前端的人才会选择的做法，这样的问题是什么呢？首先，我们每一次直接插入DIV都会导致重排发生页面重渲染，其次JS是单线程的，它与浏览器的渲染线程是互斥的，即当我们同步执行按钮回调时，页面渲染是被阻塞的，一旦这个处理环节比较长，超过了我们所谓的通感等待时长时，用户就会明显感到卡顿，这肯定是不OK的。先看看这种方案的[实现](https://chrisdeo.github.io/divDemo/raw)。

![](raw.jpg)

&emsp;&emsp;通过Chrome的Performance录制我们可以看到总共耗时1545ms才将页面渲染出来，其中在`Layout`重排这块耗时最长，同时我们也知道页面在渲染时重绘和重排都是很影响性能的操作，应当尽量减少对DOM直接操作，那么也有了我们第一步的思路，**减少对DOM的直接操作**。

#### 方案二：憨憨插入

&emsp;&emsp;那咋整嘛？不直接对DOM操作，那就间接操作呗：我们可以通过`document.createDocumentFragment`的方式，在创建的`Fragment`中进行我们的DOM插入，最后再将这个Fragment插入到父亲节点后，这样其实只有在整个`Fragment`应用时的一次重排，大大提升了渲染性能，看实际运行结果：

![](fragment.jpg)

&emsp;&emsp;看到差异了吗，通过`Fragment`的方式我们大大缩短了到渲染的时间。注意这个**到**字，个人感觉很精髓，因为即便是通过这种方式插入DOM提升了速率，但是中间这个等待JS处理的时长我们依旧可以明显地感觉到，即我们没办法看到页面如丝滑般渲染出来。有没有办法更快一点？

&emsp;&emsp;其实前面我们都在想方设法地去操作DOM，如果回头看看最早的属性`innerHTML`，我们就会突然发现这丫的不是也OK么？Virtual-DOM那些不也是在这上层套了diff比较么，最终还是会以`innerHTML`去修改，那我们就试试~

#### 方案三：萌新插入

&emsp;&emsp;使用`innerHTML`来处理，无非就是先循环构造出DOM的字符串，再设置父容器的`innerHTML`即可：

![](inner.jpg)

#### 方案四：带哥插入